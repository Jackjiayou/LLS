<view class="container"><view class="chat-header"><text class="scene-name">{{sceneName}}</text><button data-event-opts="{{[['tap',[['endPractice',['$event']]]]]}}" class="end-btn" bindtap="__e">结束</button></view><scroll-view class="chat-messages vue-ref" scroll-y="{{true}}" scroll-into-view="{{'msg-'+$root.g0}}" scroll-with-animation="{{true}}" data-ref="chatScroll"><block wx:for="{{$root.l0}}" wx:for-item="msg" wx:for-index="index" wx:key="index"><view class="{{['message-item',(msg.$orig.from==='robot')?'robot':'',(msg.$orig.from==='user')?'user':'']}}" id="{{'msg-'+(index+1)}}"><view class="message-avatar"><image src="{{msg.$orig.from==='customer'?apiBaseUrl+'/uploads/static/robot-avatar.png':apiBaseUrl+'/uploads/static/user-avatar.png'}}"></image></view><view class="message-content"><view class="voice-message-container"><block wx:if="{{msg.$orig.isLoading}}"><view class="voice-message loading-voice-bar" style="{{'width:'+(msg.m0)+';'}}"><view class="voice-icon loading-voice-icon"><label class="_span"></label></view><view class="voice-duration">...</view></view></block><block wx:else><view data-event-opts="{{[['tap',[['playVoice',['$0',index],[[['messages','',index,'voiceUrl']]]]]]]}}" class="voice-message" style="{{'width:'+(msg.m1)+';'}}" bindtap="__e"><view class="{{['voice-icon',(msg.$orig.isPlaying)?'playing':'']}}"><label class="_span"></label></view><view class="voice-duration">{{msg.$orig.duration+"''"}}</view></view></block></view><block wx:if="{{!msg.$orig.isLoading}}"><view class="text-content-container"><view class="text-transcript"><text>{{msg.$orig.text}}</text></view><block wx:if="{{msg.$orig.from==='user'}}"><view class="suggestion-wrapper"><view data-event-opts="{{[['tap',[['handleSuggestionClick',['$0',index],[[['messages','',index]]]]]]]}}" class="{{['suggestion-btn',(msg.$orig.suggestionError)?'retry-btn':'']}}" bindtap="__e"><block wx:if="{{msg.$orig.suggestionLoading}}"><text>正在生成改进建议</text><text class="loading-dot">...</text></block><block wx:else><block wx:if="{{msg.$orig.suggestionError}}"><text>重新生成建议</text><text class="retry-icon">↻</text></block><block wx:else><text>{{msg.$orig.showSuggestion?'收起改进建议':'查看改进建议'}}</text></block></block></view><block wx:if="{{msg.$orig.showSuggestion}}"><view class="suggestion-content"><view class="suggestion-title">表达建议</view><text class="suggestion-text">{{msg.$orig.suggestion}}</text></view></block></view></block></view></block></view></view></block></scroll-view><view class="input-area"><button data-event-opts="{{[['touchstart',[['handleTouchStart',['$event']]]],['touchend',[['handleTouchEnd',['$event']]]],['touchcancel',[['handleTouchCancel',['$event']]]]]}}" class="{{['voice-btn',(isRecording)?'recording':'',(isRobotLoading)?'disabled':'']}}" bindtouchstart="__e" bindtouchend="__e" bindtouchcancel="__e">{{''+(isRecording?'松开发送':isRobotLoading?'顾客正在输入...':'按住说话')+''}}</button></view><block wx:if="{{showRecordingOverlay}}"><view class="recording-overlay"><view class="recording-content"><view class="recording-icon-wrapper"><view class="{{['recording-icon',(isRecording)?'recording-animation':'']}}"></view></view><view class="recording-text">{{recordingTipText}}</view><block wx:if="{{isRecording}}"><view class="recording-time">{{recordingTime+"s"}}</view></block></view></view></block><block wx:if="{{showEndDialog}}"><view class="dialog-mask"><view class="dialog-container new-dialog"><view data-event-opts="{{[['tap',[['closeEndDialog',['$event']]]]]}}" class="dialog-close" bindtap="__e">×</view><view class="dialog-icon"><image src="/static/dialog-bubble.png" mode="aspectFit"></image></view><view class="dialog-title new-dialog-title">你确定要结束这次练习吗？</view><view class="dialog-buttons new-dialog-buttons"><button data-event-opts="{{[['tap',[['endAndViewReport',['$event']]]]]}}" class="dialog-btn dialog-btn-primary" bindtap="__e">结束对话，并查看测评报告</button><button data-event-opts="{{[['tap',[['endOnly',['$event']]]]]}}" class="dialog-btn dialog-btn-outline" bindtap="__e">结束对话</button></view></view></view></block></view>