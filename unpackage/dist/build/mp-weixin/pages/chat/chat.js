(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"47db":function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){}));var o=function(){var e=this,t=e.$createElement,s=(e._self._c,e.messages.length),o=e.__map(e.messages,(function(t,s){var o=e.__get_orig(t),n=t.isLoading?e.calculateVoiceWidth(3):null,i=t.isLoading?null:e.calculateVoiceWidth(t.duration);return{$orig:o,m0:n,m1:i}}));e.$mp.data=Object.assign({},{$root:{g0:s,l0:o}})},n=[]},"5e62":function(e,t,s){"use strict";s.r(t);var o=s("670f"),n=s.n(o);for(var i in o)["default"].indexOf(i)<0&&function(e){s.d(t,e,(function(){return o[e]}))}(i);t["default"]=n.a},"670f":function(e,t,s){"use strict";(function(e){var o=s("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=o(s("7eb4")),i=o(s("ee10")),r=o(s("0cd1")),a={data:function(){return{sceneId:0,sceneName:"",messages:[],isRecording:!1,showEndDialog:!1,recorderManager:null,currentVoicePath:"",userId:"",username:"",conversationId:"",isRobotLoading:!1,apiBaseUrl:r.default.apiBaseUrl,showRecordingOverlay:!1,recordingTipText:"准备录音...",recordingTime:0,recordingTimer:null,currentAudioContext:null,currentPlayingIndex:-1,minVoiceWidth:120,maxVoiceWidth:400,questionBank:{1:[{text:"您好，我是客户李先生111。听说贵公司有一些不错的产品，能简单介绍一下吗？",voiceUrl:this.apiBaseUrl+"/static/audio/scene1-q1.mp3",duration:"5"},{text:"我还不太了解你们公司的背景，能告诉我你们公司的情况吗？",voiceUrl:this.apiBaseUrl+"/static/audio/scene1-q2.mp3",duration:"4"},{text:"市场上类似的产品很多，贵公司的产品有什么特别之处吗？",voiceUrl:this.apiBaseUrl+"/static/audio/scene1-q3.mp3",duration:"5"}],2:[{text:"这个价格对我来说有点高，能便宜一些吗？",voiceUrl:this.apiBaseUrl+"/static/audio/scene2-q1.mp3",duration:"3"},{text:"我以前用过类似的产品，但效果不太理想，为什么我要选择你们的呢？",voiceUrl:this.apiBaseUrl+"/static/audio/scene2-q2.mp3",duration:"6"},{text:"我需要考虑一下，可以过几天再联系你吗？",voiceUrl:this.apiBaseUrl+"/static/audio/scene2-q3.mp3",duration:"4"}],3:[{text:"我需要一个能提高团队效率的工具，你们有什么推荐？",voiceUrl:"/static/audio/scene3-q1.mp3",duration:"4"},{text:"我预算有限，有什么性价比高的选择吗？",voiceUrl:"/static/audio/scene3-q2.mp3",duration:"3"},{text:"我们团队有20人，有适合团队使用的套餐吗？",voiceUrl:"/static/audio/scene3-q3.mp3",duration:"4"}],4:[{text:"我对产品很满意，但现在签合同是不是太仓促了？",voiceUrl:"/static/audio/scene4-q1.mp3",duration:"4"},{text:"如果我现在决定购买，有什么优惠吗？",voiceUrl:"/static/audio/scene4-q2.mp3",duration:"3"},{text:"购买后如果不满意，能退款吗？",voiceUrl:"/static/audio/scene4-q3.mp3",duration:"3"}]},suggestionTemplates:["您的表达可以更加简洁明了，建议减少重复词语，直接表达核心信息。","可以使用更专业的术语来增强可信度，比如将'很好的产品'改为'高性价比的解决方案'。","回答时可以加入一些数据支持，增强说服力，例如'我们的产品已帮助超过1000家企业提升了30%的效率'。","语速过快，建议适当放慢并在关键点停顿，让客户有时间消化信息。","可以先认同客户的顾虑，再提出解决方案，如'您提到的价格问题很重要，我们可以...'。"]}},onLoad:function(t){if(t.sceneId){this.sceneId=parseInt(t.sceneId);var s=e.getStorageSync("userInfo");s?(this.userId=s.userId,this.username=s.username):(this.userId="temp_"+Date.now(),this.username="游客"),this.conversationId="conv_"+Date.now(),this.getSceneInfo(),this.initRecorder(),this.messages.push({from:"customer",text:"机器人正在回复...",voiceUrl:"",duration:"",isPlaying:!1,isLoading:!0,timestamp:(new Date).toISOString()}),this.isRobotLoading=!0,this.getRobotMessage()}},methods:{getSceneInfo:function(){this.sceneName={0:"核苷酸介绍",1:"新客户开发",2:"异议处理",3:"产品推荐",4:"成交技巧"}[this.sceneId]||"未知场景"},preDownloadVoice:function(t){var s=this;t&&t.startsWith("http")&&e.downloadFile({url:t,success:function(e){if(200===e.statusCode){var o=s.messages.findIndex((function(e){return e.voiceUrl===t}));-1!==o&&s.$set(s.messages[o],"voiceUrl",e.tempFilePath)}}})},getRobotMessage:function(){var t=this;return(0,i.default)(n.default.mark((function s(){var o,i,r,a,c,u;return n.default.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return s.prev=0,t.isRobotLoading=!0,o=t.messages.filter((function(e){return!("customer"===e.from&&e.isLoading)})),s.next=5,e.request({url:t.apiBaseUrl+"/get-robot-message",method:"GET",data:{sceneId:t.sceneId,messageCount:o.length,messages:JSON.stringify(o.map((function(e){return{from:e.from,text:e.text}}))),userId:t.userId,username:t.username,conversationId:t.conversationId}});case 5:i=s.sent,200===i.statusCode&&i.data?(r=t.messages.findIndex((function(e){return"customer"===e.from&&e.isLoading})),a={from:"customer",text:i.data.text,voiceUrl:i.data.voiceUrl,duration:i.data.duration,timestamp:(new Date).toISOString(),isPlaying:!1},-1!==r?t.$set(t.messages,r,a):t.messages.push(a),i.data.voiceUrl&&t.preDownloadVoice(i.data.voiceUrl),t.$nextTick((function(){t.scrollToBottom(),t.isRobotLoading=!1}))):(c=t.messages.findIndex((function(e){return"customer"===e.from&&e.isLoading})),-1!==c&&t.messages.splice(c,1),console.error("获取机器人消息失败:",i),e.showToast({title:"获取消息失败",icon:"none"}),t.isRobotLoading=!1),s.next=16;break;case 9:s.prev=9,s.t0=s["catch"](0),u=t.messages.findIndex((function(e){return"customer"===e.from&&e.isLoading})),-1!==u&&t.messages.splice(u,1),console.error("获取机器人消息失败:",s.t0),e.showToast({title:"获取消息失败",icon:"none"}),t.isRobotLoading=!1;case 16:case"end":return s.stop()}}),s,null,[[0,9]])})))()},initRecorder:function(){var t=this;this.recorderManager=e.getRecorderManager(),this.recorderManager.onStop((function(e){console.log("录音结束事件触发:",e),e.tempFilePath&&(t.currentVoicePath=e.tempFilePath,t.sendVoiceMessage(e.tempFilePath,e.duration))})),this.recorderManager.onError((function(s){console.error("录音失败:",s),e.showToast({title:"录音失败",icon:"none"}),t.isRecording=!1}))},startRecording:function(){var t=this;this.isRecording=!0,this.showRecordingOverlay=!0,this.recordingTipText="正在录音...",this.recordingTime=0,this.recordingTimer=setInterval((function(){t.recordingTime++,t.recordingTime>=60&&(t.stopRecording(),e.showToast({title:"录音已达最大时长",icon:"none"}))}),1e3),e.authorize({scope:"scope.record",success:function(){console.log("开始录音..."),t.recorderManager.start({duration:6e4,sampleRate:16e3,numberOfChannels:1,encodeBitRate:96e3,format:"mp3",frameSize:50})},fail:function(){console.error("未授权录音权限"),t.recordingTipText="需要录音权限",setTimeout((function(){t.showRecordingOverlay=!1,t.isRecording=!1,clearInterval(t.recordingTimer)}),1500),e.showModal({title:"提示",content:"需要您授权录音权限才能发送语音消息",confirmText:"去授权",success:function(t){t.confirm&&e.openSetting()}})}})},handleTouchStart:function(){this.isRobotLoading||this.startRecording()},handleTouchEnd:function(){this.isRecording&&this.stopRecording()},handleTouchCancel:function(){this.isRecording&&this.cancelRecording()},stopRecording:function(){var e=this;this.isRecording&&(console.log("结束录音"),this.isRecording=!1,this.recordingTipText="发送中...",clearInterval(this.recordingTimer),this.recorderManager.stop(),setTimeout((function(){e.showRecordingOverlay=!1}),1e3))},cancelRecording:function(){var e=this;console.log("取消录音"),this.isRecording=!1,this.recordingTipText="已取消",clearInterval(this.recordingTimer),this.recorderManager.stop(),setTimeout((function(){e.showRecordingOverlay=!1}),1e3)},sendVoiceMessage:function(e,t){console.log("发送语音消息:",e,t);var s=Math.ceil(t/1e3);this.uploadVoiceAndGetText(e,s)},uploadVoiceAndGetText:function(t,s){var o=this,n=(new Date).getTime(),i=Math.random().toString(36).substring(2,8),r="audio_".concat(n,"_").concat(i,".mp3"),a=this.messages.length;this.messages.push({from:"user",text:"语音识别中...",voiceUrl:t,duration:"",suggestion:"",polishedText:"",showSuggestion:!1,isPlaying:!1,suggestionLoading:!1,suggestionError:!1,isLoading:!0}),this.scrollToBottom(),e.uploadFile({url:"".concat(this.apiBaseUrl,"/speech-to-text"),filePath:t,name:"audio_file",formData:{userId:this.userId,username:this.username,conversationId:this.conversationId,sceneId:this.sceneId,fileName:r},success:function(n){try{var i=JSON.parse(n.data);i.text?(o.$set(o.messages,a,{from:"user",text:i.text,voiceUrl:i.voiceUrl||t,duration:s.toString(),suggestion:"",polishedText:"",showSuggestion:!1,isPlaying:!1,suggestionLoading:!0,suggestionError:!1,isLoading:!1}),i.voiceUrl&&o.preDownloadVoice(i.voiceUrl),o.scrollToBottom(),o.messages.push({from:"customer",text:"机器人正在回复...",voiceUrl:"",duration:"",isPlaying:!1,isLoading:!0,timestamp:(new Date).toISOString()}),o.isRobotLoading=!0,o.getRobotMessage(),o.getMessageSuggestion(i.text,a)):(o.messages.splice(a,1),e.showToast({title:"语音识别失败",icon:"none"}))}catch(r){o.messages.splice(a,1),console.error("解析语音识别结果失败:",r),e.showToast({title:"语音识别失败",icon:"none"})}},fail:function(t){o.messages.splice(a,1),console.error("上传语音失败:",t),e.showToast({title:"上传语音失败",icon:"none"})},complete:function(){e.hideLoading()}})},getMessageSuggestion:function(t,s){var o=this,n=this.messages.filter((function(e){return!("customer"===e.from&&e.isLoading)}));this.$set(this.messages[s],"suggestionLoading",!0),this.$set(this.messages[s],"suggestionError",!1),e.request({url:"".concat(this.apiBaseUrl,"/analyze"),method:"POST",data:{messages_all:JSON.stringify(n.map((function(e){return{from:e.from,text:e.text}}))),sceneId:this.sceneId,message:t,allMessages:this.formatMessagesForAnalysis()},success:function(e){e.data&&e.data.suggestion?(o.$set(o.messages[s],"suggestion",e.data.suggestion),o.$set(o.messages[s],"suggestionLoading",!1),o.$set(o.messages[s],"suggestionError",!1)):(o.$set(o.messages[s],"suggestionLoading",!1),o.$set(o.messages[s],"suggestionError",!0))},fail:function(e){o.$set(o.messages[s],"suggestionLoading",!1),o.$set(o.messages[s],"suggestionError",!0)}})},getPolishedText:function(t,s){var o=this;e.request({url:"".concat(this.apiBaseUrl,"/polish-text"),method:"POST",data:{text:t,sceneId:this.sceneId},success:function(e){e.data&&e.data.polishedText&&(console.log("获取润色表达成功:",e.data),o.$set(o.messages[s],"polishedText",e.data.polishedText))},fail:function(e){console.error("获取润色表达失败:",e),o.$set(o.messages[s],"polishedText","润色表达生成失败，请稍后再试")}})},formatMessagesForAnalysis:function(){return this.messages.map((function(e){return{role:"user"===e.from?"user":"customer",content:e.text}}))},scrollToBottom:function(){var t=this;this.$nextTick((function(){var s=e.createSelectorQuery().in(t);s.select(".chat-messages").boundingClientRect((function(t){t&&e.pageScrollTo({scrollTop:t.height,duration:300})})).exec()}))},playVoice:function(t,s){var o=this;if(console.log("播放语音",t),t)if(this.currentPlayingIndex!==s){if(this.currentAudioContext){try{this.currentAudioContext.stop(),this.currentAudioContext.destroy()}catch(n){console.error("停止当前音频失败:",n)}this.currentPlayingIndex>=0&&this.currentPlayingIndex<this.messages.length&&this.$set(this.messages[this.currentPlayingIndex],"isPlaying",!1)}this.$set(this.messages[s],"isPlaying",!0),this.currentPlayingIndex=s,this.currentAudioContext=e.createInnerAudioContext(),t.startsWith("http")?(console.log("下载并播放网络音频:",t),e.downloadFile({url:t,success:function(e){if(console.log("音频下载成功:",e),200===e.statusCode){o.currentAudioContext.src=e.tempFilePath,console.log("使用下载的本地文件播放:",e.tempFilePath),o.currentAudioContext.onPlay((function(){console.log("开始播放")})),o.currentAudioContext.onError((function(e){console.error("播放错误:",e),console.error("播放失败的URL:",t),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1;try{o.currentAudioContext.destroy(),o.currentAudioContext=null}catch(n){console.error("销毁音频上下文失败:",n)}})),o.currentAudioContext.onEnded((function(){console.log("播放结束"),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1;try{o.currentAudioContext.destroy(),o.currentAudioContext=null}catch(n){console.error("销毁音频上下文失败:",n)}}));try{o.currentAudioContext.play()}catch(n){console.error("播放音频失败:",n),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1}}else console.error("下载失败，状态码:",e.statusCode),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1},fail:function(e){console.error("下载失败:",e),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1}})):e.getFileInfo({filePath:t,success:function(){o.currentAudioContext.src=t,console.log("使用本地文件播放:",t),o.currentAudioContext.onPlay((function(){console.log("开始播放")})),o.currentAudioContext.onError((function(e){console.error("播放错误:",e),console.error("播放失败的URL:",t),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1;try{o.currentAudioContext.destroy(),o.currentAudioContext=null}catch(n){console.error("销毁音频上下文失败:",n)}})),o.currentAudioContext.onEnded((function(){console.log("播放结束"),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1;try{o.currentAudioContext.destroy(),o.currentAudioContext=null}catch(n){console.error("销毁音频上下文失败:",n)}}));try{o.currentAudioContext.play()}catch(n){console.error("播放音频失败:",n),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1}},fail:function(){console.error("文件不存在:",t),o.$set(o.messages[s],"isPlaying",!1),o.currentPlayingIndex=-1}})}else try{this.currentAudioContext.stop(),this.currentAudioContext.destroy(),this.currentAudioContext=null,this.$set(this.messages[s],"isPlaying",!1),this.currentPlayingIndex=-1}catch(n){console.error("停止当前音频失败:",n)}else e.showToast({title:"无效的语音文件",icon:"none"})},toggleSuggestion:function(e){this.$set(this.messages[e],"showSuggestion",!this.messages[e].showSuggestion)},sendMessageToBackend:function(e){console.log("发送消息到后端分析:",e)},endPractice:function(){this.showEndDialog=!0},closeEndDialog:function(){this.showEndDialog=!1},endOnly:function(){e.navigateBack({delta:2})},endAndViewReport:function(){this.generateReport(),e.navigateTo({url:"/pages/report/report?sceneId=".concat(this.sceneId)})},generateReport:function(){console.log("生成练习报告..."),e.request({url:"".concat(this.apiBaseUrl,"/report"),method:"POST",data:{sceneId:this.sceneId,userId:"user1",messages:this.formatMessagesForAnalysis()},success:function(t){console.log("报告生成成功:",t.data),t.data&&t.data.reportId&&e.setStorageSync("latestReportId",t.data.reportId)},fail:function(t){console.error("报告生成失败:",t),e.showToast({title:"报告生成失败",icon:"none"})}})},calculateVoiceWidth:function(e){var t=parseInt(e)||0,s=this.minVoiceWidth+t/60*(this.maxVoiceWidth-this.minVoiceWidth);return s=Math.max(this.minVoiceWidth,Math.min(s,this.maxVoiceWidth)),s+"rpx"},handleSuggestionClick:function(e,t){e.suggestionError?(this.$set(this.messages[t],"suggestionLoading",!0),this.$set(this.messages[t],"suggestionError",!1),this.getMessageSuggestion(e.text,t)):this.toggleSuggestion(t)}}};t.default=a}).call(this,s("df3c")["default"])},"741b":function(e,t,s){},a389:function(e,t,s){"use strict";s.r(t);var o=s("47db"),n=s("5e62");for(var i in n)["default"].indexOf(i)<0&&function(e){s.d(t,e,(function(){return n[e]}))}(i);s("dd8e");var r=s("828b"),a=Object(r["a"])(n["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);t["default"]=a.exports},b04f:function(e,t,s){"use strict";(function(e,t){var o=s("47a9");s("5fd2");o(s("3240"));var n=o(s("a389"));e.__webpack_require_UNI_MP_PLUGIN__=s,t(n.default)}).call(this,s("3223")["default"],s("df3c")["createPage"])},dd8e:function(e,t,s){"use strict";var o=s("741b"),n=s.n(o);n.a}},[["b04f","common/runtime","common/vendor"]]]);